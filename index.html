<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√†nh Tr√¨nh Ng√†n NƒÉm - B·∫£n ƒê·ªì L·ªãch S·ª≠ Vi·ªát Nam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Be+Vietnam+Pro', sans-serif;
            background-color: #f4f1ea;
        }

        #map {
            height: calc(100vh - 80px);
            width: 100%;
            z-index: 1;
            border-bottom: 4px solid #c2410c;
        }

        .history-card {
            max-height: 500px;
            overflow-y: auto;
        }

        .active-event {
            border-color: #c2410c !important;
            background-color: #fff7ed !important;
            box-shadow: 0 10px 15px -3px rgba(194, 65, 12, 0.2);
        }

        .timeline-container::-webkit-scrollbar {
            height: 6px;
        }
        .timeline-container::-webkit-scrollbar-thumb {
            background: #c2410c;
            border-radius: 10px;
        }

        /* Loading animation cho AI */
        .dot-flashing {
            position: relative;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #c2410c;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: .5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: ''; display: inline-block; position: absolute; top: 0;
            width: 6px; height: 6px; border-radius: 5px; background-color: #c2410c;
        }
        .dot-flashing::before { left: -12px; animation: dot-flashing 1s infinite alternate; animation-delay: 0s; }
        .dot-flashing::after { left: 12px; animation: dot-flashing 1s infinite alternate; animation-delay: 1s; }
        @keyframes dot-flashing { 0% { opacity: 1; } 50%, 100% { opacity: 0.2; } }
    </style>
</head>
<body class="overflow-hidden">

    <!-- Header -->
    <header class="h-20 bg-stone-900 text-white flex items-center justify-between px-6 shrink-0 shadow-xl">
        <div class="flex items-center gap-4">
            <div class="bg-orange-600 p-2.5 rounded-xl shadow-inner">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-tight text-orange-400">ƒê·∫†I VI·ªÜT S·ª¨ K√ù</h1>
                <p class="text-[10px] text-stone-400 uppercase tracking-widest">B·∫£n ƒë·ªì s·ªë L·ªãch s·ª≠ Vi·ªát Nam v2.0</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleChat()" class="px-5 py-2.5 bg-orange-600 hover:bg-orange-500 rounded-xl text-xs font-bold transition-all shadow-lg active:scale-95">
                TR·ª¢ L√ù AI
            </button>
        </div>
    </header>

    <main class="relative h-[calc(100vh-80px)]">
        <!-- Map -->
        <div id="map"></div>

        <!-- Sidebar Info -->
        <div id="info-panel" class="absolute top-6 right-6 z-[1000] w-80 md:w-96 bg-white shadow-2xl rounded-3xl overflow-hidden hidden border border-stone-200 transition-all duration-500 transform translate-x-full">
            <button onclick="closePanel()" class="absolute top-4 right-4 z-10 p-2 bg-stone-900/50 hover:bg-stone-900 text-white rounded-full transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div id="panel-content" class="history-card"></div>
            <div id="ai-insight-box" class="p-5 bg-stone-50 border-t border-stone-100 hidden">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-orange-600">‚ú®</span>
                    <h4 class="text-xs font-bold text-stone-800 uppercase">AI Ph√¢n t√≠ch</h4>
                </div>
                <div id="ai-insight-text" class="text-xs text-stone-600 leading-relaxed italic"></div>
            </div>
        </div>

        <!-- AI Chat -->
        <div id="ai-chat-panel" class="absolute top-6 left-6 z-[1000] w-80 md:w-96 h-[500px] bg-white shadow-2xl rounded-3xl flex flex-col hidden border border-stone-200 overflow-hidden">
            <div class="p-4 bg-stone-900 text-white flex justify-between items-center">
                <span class="text-sm font-bold flex items-center gap-2"><span>ü§ñ</span> S·ª≠ gia AI</span>
                <button onclick="toggleChat()" class="text-stone-400 hover:text-white">‚úï</button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-stone-50 text-xs">
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-stone-100">Ch√†o b·∫°n! T√¥i l√† S·ª≠ gia AI. B·∫°n c√≥ th·∫Øc m·∫Øc g√¨ v·ªÅ c√°c s·ª± ki·ªán l·ªãch s·ª≠ tr√™n b·∫£n ƒë·ªì kh√¥ng?</div>
            </div>
            <form onsubmit="event.preventDefault(); sendMessage();" class="p-3 bg-white border-t flex gap-2">
                <input type="text" id="chat-input" placeholder="H·ªèi v·ªÅ s·ª≠ Vi·ªát..." class="flex-1 px-4 py-2 bg-stone-100 rounded-xl text-xs outline-none focus:ring-2 focus:ring-orange-500">
                <button class="p-2 bg-orange-600 text-white rounded-xl">‚û§</button>
            </form>
        </div>

        <!-- Timeline -->
        <div class="absolute bottom-10 left-0 right-0 z-[1000] px-6">
            <div class="max-w-6xl mx-auto bg-white/80 backdrop-blur-md p-4 rounded-3xl shadow-2xl border border-white/50 overflow-x-auto timeline-container">
                <div class="flex gap-4 min-w-max" id="timeline-list"></div>
            </div>
        </div>
    </main>

    <script>
        const apiKey = ""; 

        // D·ªØ li·ªáu s·ª± ki·ªán k√®m ·∫£nh d·ª± ph√≤ng (fallback) ƒë·ªÉ tr√°nh l·ªói "t√πm l√πm"
        const historyEvents = [
            { 
                id: 1, title: "Chi·∫øn th·∫Øng B·∫°ch ƒê·∫±ng", year: "938", era: "Th·ªùi Ng√¥", 
                location: [20.849, 106.657], image: "image_751c49.jpg",
                fallback: "https://www.kidsup.net/wp-content/uploads/2025/07/boi-canh-lich-su-thoi-ngo-quyen.jpg$0",
                desc: "Ng√¥ Quy·ªÅn d√πng k·∫ø c·∫Øm c·ªçc g·ªó nh·ªçn tr√™n s√¥ng B·∫°ch ƒê·∫±ng ti√™u di·ªát qu√¢n Nam H√°n, k·∫øt th√∫c ngh√¨n nƒÉm B·∫Øc thu·ªôc."
            },
            { 
                id: 2, title: "L√Ω Th√°i T·ªï D·ªùi ƒê√¥", year: "1010", era: "Th·ªùi L√Ω", 
                location: [21.036, 105.834], image: "image_75722a.jpg",
                fallback: "https://photo.znews.vn/w1920/Uploaded/dqmblcvo/2020_08_03/72319060_2432162433500377_8155838751289901056_o.jpg$0",
                desc: "Vua L√Ω C√¥ng U·∫©n ban Chi·∫øu d·ªùi ƒë√¥ t·ª´ Hoa L∆∞ v·ªÅ th√†nh ƒê·∫°i La, ƒë·ªïi t√™n th√†nh ThƒÉng Long."
            },
            { 
                id: 3, title: "Chi·∫øn th·∫Øng ƒê·ªëng ƒêa", year: "1789", era: "T√¢y S∆°n", 
                location: [21.002, 105.821], image: "image_751cc7.png",
                fallback: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/86/Battle_at_the_River_Tho-xuong.jpg/500px-Battle_at_the_River_Tho-xuong.jpg$0",
                desc: "Vua Quang Trung h√†nh qu√¢n th·∫ßn t·ªëc qu√©t s·∫°ch 29 v·∫°n qu√¢n Thanh ngay trong d·ªãp T·∫øt K·ª∑ D·∫≠u."
            },
            { 
                id: 4, title: "Chi·∫øn Th·∫Øng ƒêi·ªán Bi√™n Ph·ªß", year: "1954", era: "Ch·ªëng Ph√°p", 
                location: [21.388, 103.018], image: "image_756f42.jpg",
                fallback: "https://media-cdn-v2.laodong.vn/Storage/NewsPortal/2023/5/7/1189327/Chien-Thang-Dien-Bie.jpg$0",
                desc: "Chi·∫øn th·∫Øng vƒ© ƒë·∫°i k·∫øt th√∫c √°ch ƒë√¥ h·ªô c·ªßa th·ª±c d√¢n Ph√°p t·∫°i ƒê√¥ng D∆∞∆°ng."
            },
            { 
                id: 5, title: "Gi·∫£i ph√≥ng Mi·ªÅn Nam", year: "1975", era: "Ch·ªëng M·ªπ", 
                location: [10.777, 106.695], image: "image_7579ca.jpg",
                fallback: "https://imgnvsk.vnanet.vn/MediaUpload/Content/2025/04/16/116-15-33-31.jpg$0",
                desc: "Chi·∫øn d·ªãch H·ªì Ch√≠ Minh l·ªãch s·ª≠, th·ªëng nh·∫•t ƒë·∫•t n∆∞·ªõc Vi·ªát Nam."
            }
        ];

        // Kh·ªüi t·∫°o B·∫£n ƒë·ªì
        const map = L.map('map', { zoomControl: false }).setView([16.0, 108.0], 6);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png').addTo(map);

        async function askGemini(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "T√¥i ch∆∞a r√µ v·ªÅ v·∫•n ƒë·ªÅ n√†y.";
            } catch (e) { return "L·ªói k·∫øt n·ªëi tr√≠ tu·ªá nh√¢n t·∫°o."; }
        }

        function showInfo(id) {
            const event = historyEvents.find(e => e.id === id);
            const panel = document.getElementById('info-panel');
            const content = document.getElementById('panel-content');
            
            panel.classList.remove('hidden');
            setTimeout(() => panel.style.transform = "translateX(0)", 10);

            content.innerHTML = `
                <div class="relative h-56 bg-stone-200">
                    <img src="${event.image}" class="w-full h-full object-cover" 
                         onerror="this.onerror=null; this.src='${event.fallback}';">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                    <div class="absolute bottom-4 left-6 text-white">
                        <span class="text-[9px] font-bold uppercase tracking-widest text-orange-400">${event.era}</span>
                        <h2 class="text-2xl font-black">${event.title}</h2>
                    </div>
                </div>
                <div class="p-6">
                    <p class="text-sm text-stone-600 leading-relaxed mb-6">${event.desc}</p>
                    <button onclick="getAIInsight(${id})" class="w-full py-3 bg-stone-900 text-white rounded-2xl text-[10px] font-bold tracking-widest hover:bg-orange-600 transition-all shadow-lg active:scale-95">
                        PH√ÇN T√çCH √ù NGHƒ®A ‚ú®
                    </button>
                </div>
            `;

            map.flyTo(event.location, 12, { animate: true, duration: 1 });
            
            document.querySelectorAll('.timeline-item').forEach(el => el.classList.remove('active-event'));
            document.getElementById(`timeline-${id}`).classList.add('active-event');
        }

        async function getAIInsight(id) {
            const event = historyEvents.find(e => e.id === id);
            const box = document.getElementById('ai-insight-box');
            const text = document.getElementById('ai-insight-text');
            box.classList.remove('hidden');
            text.innerHTML = '<div class="py-2"><div class="dot-flashing"></div></div>';
            
            const result = await askGemini(`N√™u ng·∫Øn g·ªçn 2 √Ω nghƒ©a l·ªãch s·ª≠ c·ªßa ${event.title} nƒÉm ${event.year}.`);
            text.innerText = result;
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const messages = document.getElementById('chat-messages');
            const val = input.value.trim();
            if(!val) return;

            messages.innerHTML += `<div class="bg-orange-50 p-3 rounded-2xl text-right ml-10 border border-orange-100">${val}</div>`;
            input.value = "";
            
            const loading = document.createElement('div');
            loading.className = "bg-white p-3 rounded-2xl border border-stone-100 w-fit";
            loading.innerHTML = '<div class="dot-flashing m-2"></div>';
            messages.appendChild(loading);
            messages.scrollTop = messages.scrollHeight;

            const res = await askGemini(val);
            loading.remove();
            messages.innerHTML += `<div class="bg-white p-3 rounded-2xl border border-stone-100 shadow-sm">${res}</div>`;
            messages.scrollTop = messages.scrollHeight;
        }

        function toggleChat() { document.getElementById('ai-chat-panel').classList.toggle('hidden'); }
        function closePanel() { document.getElementById('info-panel').style.transform = "translateX(110%)"; }

        // Render Timeline
        const tList = document.getElementById('timeline-list');
        historyEvents.forEach(e => {
            // Marker
            L.marker(e.location).addTo(map).on('click', () => showInfo(e.id));
            
            // Timeline Item
            const div = document.createElement('div');
            div.id = `timeline-${e.id}`;
            div.className = "timeline-item bg-white px-5 py-3 rounded-2xl border border-stone-200 cursor-pointer transition-all hover:border-orange-500 w-40 shrink-0";
            div.innerHTML = `<p class="text-[9px] font-bold text-orange-600">${e.year}</p><p class="text-xs font-bold text-stone-800 truncate">${e.title}</p>`;
            div.onclick = () => showInfo(e.id);
            tList.appendChild(div);
        });
    </script>
</body>
</html>
